<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Structured Logging - 2015/01/28 @ ThoughtWorks Xi'An - Laurence J MacGuire</title>

		<meta name="description" content="A framework for easily creating beautiful presentations using HTML">
		<meta name="author" content="Hakim El Hattab">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<link rel="stylesheet" href="css/reveal.min.css">
		<link rel="stylesheet" href="css/theme/default.css" id="theme">

		<!-- For syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- If the query includes 'print-pdf', include the PDF print sheet -->
		<script>
			if( window.location.search.match( /print-pdf/gi ) ) {
				var link = document.createElement( 'link' );
				link.rel = 'stylesheet';
				link.type = 'text/css';
				link.href = 'css/print/pdf.css';
				document.getElementsByTagName( 'head' )[0].appendChild( link );
			}
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section>
					<h1>Structured Logging</h1>
					<h3>A Working Example</h3>
					<p>
						<small>Created by <a href="http://github.com/leprechaun/">Laurence J MacGuire a.k.a Liu Jian Ming aka 刘建明</a></small>
					</p>
					<p>
						<small>Thought<span style="font-weight: bold; color: white;">Works</span> Xi'An, 2015/05/20</small>
					</p>

					<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a>
				</section>

				<section>
						<h2>The 5 "W's"</h2>
						<ul>
							<li>Who?</li>
							<li>What?</li>
							<li>Where?</li>
							<li>When?</li>
							<li>Why?</li>
							<li>... and How?</li>
						</ul>
				</section>

				<section>
						<h2>What are logs?</h2>
						<ul>
							<li>Debugging</li>
							<li>Auditing</li>
							<li>Profiling</li>
						</ul>
				</section>

				<section>
						<h2>Distributed logging</h2>
						<ul>
							<li>Horizontal vs Vertical scaling</li>
						</ul>
						<pre><code>ssh user@system-01.xyz.com && tail -f /var/log/my-application.log
ssh user@system-02.xyz.com && tail -f /var/log/my-application.log
ssh user@system-XX.xyz.com && tail -f /var/log/my-application.log</code></pre>
						<blockquote>NOPE! NOPE! NOPE!</blockquote>
				</section>

				<section>
						<h2>Centralised Access</h2>
						<blockquote>"Distribute data and processing, but centralise access."</br>
						-- Me</blockquote>
						<ul>
							<li>rsyslog</li>
							<li>graylog</li>
							<li>lumberjack</li>
							<li>sftp/s3/whatever</li>
						</ul>
				</section>

				<section>
						<h2>File based logs</h2>

						<pre><code>127.0.0.1 - - [01/Feb/2015:12:41:18 +0800] "GET /optout_check?callback=Krux.ns._default.kxjsonp_optOutCheck HTTP/1.1" 404 506 "http://www.theguardian.com/us-news/2015/jan    /31/detroit-aiyana-stanley-jones-police-officer-cleared" "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Ubuntu Chromium/39.0.2171.65 Chrome/39.0.    2171.65 Safari/537.36"</code></pre>
						<pre><code>$&gt; cat access.log | awk '{print $1}' | sort -n | uniq -c | sort -nr
  29877 93.xxx.xxx.xxx
  17538 80.xxx.xxx.xxx
   5895 198.xxx.xxx.xxx
   3042 37.xxx.xxx.xxx
   2956 208.xxx.xxx.xxx
   2613 94.xxx.xxx.xxx
   ...</code></pre>
						<blockquote>Cool! But not accessible.</blockquote>
				</section>

				<section>
						<h2>It still fails</h2>
						<h3>Some formats are really hard to parse</h3>
						<pre><code>
Started GET "/meta/processed_dates.json" for 127.0.0.1 at 2015-01-25 18:24:49 +0800
Processing by Meta::ProcessedDatesController#all as JSON
  Rendered text template (0.0ms)
Completed 404 Not Found in 8.4ms (Views: 4.9ms | ActiveRecord: 0.5ms)
						</code></pre>

						<blockquote>But there's really cool information in there!</blockquote>
				</section>

				<section>
						<h2>Better log formats</h2>
						<pre><code>
host=8.8.8.8 level=info ip=86.86.86.86 msg=hello world ...
						</code></pre>

						<div class="fragment">
							<blockquote>Why not JSON!</blockquote>
						<pre><code>
{"host":"8.8.8.8","level":"info","ip":"86.86.86.86","msg":"hello world", ...}
						</code></pre>
						</div>
				</section>

				<section>
						<h2>Enter Logstash</h2>
						<blockquote>About logs. But not really about logs</blockquote>
						<ul>
							<li class="fragment">Written in Ruby/JVM</li>
							<li class="fragment">Actually just a generic event processor</li>
							<li class="fragment">With some logging specific tooling</li>
							<li class="fragment">OpenSource</li>
						</ul>
				</section>

				<section>
						<h2>Logstash Workflow</h2>
						<img src="images/logstash-workflow.png" />
				</section>

				<section>
						<h2>Config - Inputs</h2>
						<p>Events go in, somehow</p>
						<ul>
							<li>files</li>
							<li>tcp/ip
								<ul>
									<li>rsyslog</li>
									<li>graylog</li>
									<li>lumberjack</li>
									<li>stomp</li>
								</ul>
							</li>
							<li>Write your own: it's ruby</li>
						</ul>
				</section>

				<section>
						<h2>Config - Filters</h2>
						<p>Do stuff to your events</p>
						<ul>
							<li>date: standardise dates</li>
							<li>grok: big collection of RegExp</li>
							<li>json: parse JSON</li>
							<li>geoip: IP to Geo information</li>
							<li>metrics: event statistics aggregation</li>
							<li>Write your own: it's ruby</li>
						</ul>
				</section>

				<section>
						<h2>Config - Outputs</h2>
						<p>Put them somewhere</p>
						<ul>
							<li>ElasticSearch</li>
							<li>Email</li>
							<li>File</li>
							<li>Graphite</li>
							<li>Write your own: it's ruby</li>
						</ul>
				</section>

				<section>
						<h2>ElasticSearch</h2>
						<p>More or less ...</p>
						<ul>
							<li>JSON/HTTP based API</li>
							<li>A transaction log</li>
							<li>Distributed storage and retrieval</li>
							<li>Lucene search engine</li>
							<li>Good cloud support</li>
							<li>OpenSource</li>
						</ul>
				</section>



				<section>
						<h2>Example configs</h2>
						<p>nginx access logs</p>
						<pre><code>
log_format logstash_json '{ "@timestamp": "$time_iso8601", '
                         '"clientip": "$remote_addr", '
                         '"time_spent.total": $request_time, '
                         '"forwarded_for": "$http_x_forwarded_for", '
                         '"response.cache_status": "$upstream_cache_status", '
                         '"response.mime_type": "$sent_http_content_type", '
                         '"response.status": $status, '
                         '"response.size": $body_bytes_sent, '
                         '"request.path": "$request_uri", '
                         '"request.verb": "$request_method", '
                         '"request.referrer": "$http_referer", '
                         '"request.host": "$host", '
                         '"request.agent": "$http_user_agent" }';</code></pre>
				</section>

				<section>
					<section>
						<h2>Example configs</h2>
						<p>logstash-forwarder</p>
						<pre><code>{
  "network": {
    "servers": [ "lumberjack-cluster.example.com:443" ],
    "ssl certificate": "/opt/logstash-forwarder/logstash-server.crt",
    "ssl key": "/opt/logstash-forwarder/logstash-server.key",
    "ssl ca": "/opt/logstash-forwarder/logstash-server.crt"
  },
  "files": [
    {
      "paths": [
        "/var/log/my-ruby-app/production.log"
      ],
      "fields": {
        "type": "http_access_logs",
        "source.tier": "unicorn",
        "source.application": "my-ruby-app",
        "source.project": "my-project"
      }
    },

    {
      "paths": [
        "/var/log/nginx/logstash_json.log"
      ],
      "fields": {
        "type": "http_access_logs",
        "source.tier": "nginx",
        "source.application": "my-ruby-app",
        "source.project": "my-project"
       }
    }
  ]
}</code></pre>
					</section>
					
					<section>
						<h2>Example configs</h2>
						<p>syslog</p>
						<pre><code>*.* action(type="omtcp" target="w.x.y.z" port="514")</code></pre>
					</section>
				</section>

				<section>
						<h2>Example configs</h2>
						<p>Logstash</p>
						<pre><code>
input {
	lumberjack {
		port => 443
		ssl_certificate => "/opt/logstash/lumberjack.crt"
		ssl_key => "/opt/logstash/lumberjack.key"
		codec => "json"
	}
}

output {
	elasticsearch {
		host => "my-elasticsearch-cluster.example.com"
		cluster => "my-elasticsearch-cluster-name"
		protocol => "http"
	}
}</code></pre>
				</section>



				<section>
						<h2>Now What?</h2>
						<p>All your events are in a distributed, easily queryable datastore</p>
						<pre><code>
						curl -XPOST http://my-elasticsearchcluster.example.com/_search -d '{"query":{"bool":{"must":[{"term":{"http_access_logs.response.status":"404"}}],"must_not":[],"should":[]}},"from":0,"size":10,"sort":[],"facets":{}}'

{
	"took": 1357,
	"timed_out": false,
	"_shards": {
		"total": 4,
		"successful": 4,
		"failed": 0
	},
	"hits": {
		"total": 184229,
		"max_score": 1,
		"hits": [
			{
				"_index": "logstash-2015.01.25",
				"_type": "http_access_logs",
				"_id": "AUsfjnQ7mXbLjGbOXHyr",
				"_score": 1,
				"_source": {
					"@timestamp": "2015-01-25T05:20:10.182Z",
					"type": "http_access_logs",
					"timestamp": "2015-01-25T05:20:10.182641Z",
					"request": {
						"scheme": "http",
						"host": "investor-api.realestate.com.au",
						"port": 80,
						"path": "/states/tas/suburbs/goshen.json",
						"query": null,
						"fragment": null,
						"complete": "http://investor-api.realestate.com.au/states/tas/suburbs/goshen.json",
						"verb": "GET",
						"http_version":"HTTP/1.1",
						"size": 0
					},
					"response": {
						"status": 404,
						"size": 21,
					},

					"time_spent": {
						"request_processing": 0.000049,
						"backend": 0.012,
						"response_processing": 0.000042,
						"total": 0.012505
					},
					"source": {
						"lob": "mad",
						"project": "investor",
						"application": "investor-api",
						"stack": "b",
						"tier": "elb"
					},
			}
		]
	}
}</code></pre>
						<blocquote>Well, kind of easy ...</blockquote>
				</section>

				<section>
						<h2>Kibana: Making it easier</h2>
						<ul>
							<li>100% Javascript + CSS + HTML application</li>
							<li>Talks to ElasticSearch directly</li>
							<li>Beautiful graphs!</li>
							<li>OpenSource</li>
						</ul>
				</section>

				<section>
						<h2>Demo time!</h2>
						<a href="https://mad-logs.realestate.com.au/">https://mad-logs.realestate.com.au/</a>
				</section>

				<section>
						<h2>What should you log?</h2>
						<img src="images/leon-everyone.gif" />
						<blockquote>"<span style="text-decoration: line-through;">Everyone</span>Everything!"</blockquote>
				</section>

				<section>
						<h2>Seriously!</h2>
						<p>System logs</p>
						<ul>
							<li>kernel boot logs</li>
							<li>security log</li>
							<li>linux subsystem logs</li>
						</ul>
				</section>

				<section>
						<h2>More!</h2>
						<p>Application logs</p>
						<ul>
							<li>Backend App logs</li>
							<li>Especially App startup</li>
							<li>Also: TIMING INFORMATION!</li>
						</ul>
						<blockquote>"If your logs don't give you a *really really* good clue what happened. They're useless"</br/> -- Me</blockquote>
				</section>

				<section>
						<h2>MOAR!</h2>
						<p>Application *business* logs</p>
						Try logging all business/domain relavant events.
						<ul>
							<li>Users: create, login, forget password</li>
							<li>Posts: create, reply, delete</li>
							<li>Capture metrics!</li>
						</ul>
				</section>

				<section>
					<h2>MOOOOOOOAAARRRRR!!!</h2>
					<ul>
						<li>Access logs
							<ul>
								<li>Unicorn/whatever (app)</li>
								<li>Nginx/Apache (proxy)</li>
								<li>ELB/HAProxy (load-balancer)</li>
								<li>Cloudfront/CDN?</li>
							</ul>
						</li>
					</ul>
				</section>

				<section>
					<h2>Also (really) important</h2>
					<ul>
						<li>Application auto-scaling event</li>
						<li>Instance/application boot up</li>
						<li>Deployment events (deploy, switch, revert, etc)</li>
					</ul>
				</section>

				<section>
					<h2>I might actually be insane</h2>
					<ul>
						<li>Browser-side application logs?</li>
						<li>Browser-side user-interaction logs?</li>
						<li>I've done it for fun. Why not!?</li>
					</ul>
				</section>


				<section>
					<h2>Shifting mindsets</h2>
					<blockquote>"Logs aren't files full of stacktraces you never read. They're an event stream that should be treated and processed like a first-class citizen."</br>-- Me</blockquote>
				</section>

				<section>
					<h2>Tip: Apps are in control</h2>
					Developers are aware of the business context. Let them log appropriately.
				</section>

				<section>
					<h2>Tip: Type-cast events</h2>
					<pre><code>{"user":{"id":"124"}}</code></pre>
					Nope! We're shoving this in a database. Treat it with respect.
				</section>

				<section>
					<h2>Tip: Clearly label event sources</h2>
					<pre><code>{
	"source":{
		"lob":"MAD",
		"project":"investor",
		"application":"investor-api",
		"tier":"nginx",
		"host": "W.X.Y.Z",
		"etc": "sdfsf"
	}
}</code></pre>
				</section>

				<section>
					<h2>Tip: Re-use event type information</h2>
					Unicorn, Nginx/Apache, ELB ... they all log
					<pre><code>request: {
	"verb": "GET",
	"path": "/somewhere/file.html",
	"http_version": "1.1",
	"host": "virtual-host.domain.com",
	"referer": "http://www.some-other-domain/page.html",
	"user-agent": "Mozilla Compatible (blah blah)"
},
response: {
	"status": 200,
	"size": 123123,
	"etc": "asdasda"
}</code></pre>
					These app mostly log (more or less) the same information. Categorise accordingly.
				</section>

				<section>
					<section>
						<h2>Tip: Include run-time information</h2>
						<p>Which user made this post?</p>
						<pre><code>{
	"board.id":123
	"board.name":"Self-help",
	"sender.id":3462,
	"sender.username": "lmac",
	"post.subjet": "Lol, wut?"
}</code></pre>

					</section>
					<section>
						<h2>Tip: Include run-time information</h2>
						<p>To and from which address was this email sent?</p>
						<pre><code>{
	"from.address":"bob@example.com",
	"to.address":"alice@example.com",
	"sender.username":"bob_awesome_saas",
	"message.id": "eeaa4f14-c720-4c9f-b2f8-b5b859e49e46",
	"message.subjet": "password reminder",
	"message.status": "relayed"
}</code></pre>
					</section>
					<section>
						<h2>Tip: Include run-time information</h2>
						<p>Which build number is running?</p>
							<pre><code>{
		"source.project":"my-awesome-saas-thing",
		"source.app":"thingamabobinator",
		"source.build_number":"master-666-ed3dab32"
	}</code></pre>
					</section>

					<section>
						<h2>Tip: Include run-time information</h2>
						<p>Which build number is running?</p>
							<pre><code>{
	"source.project":"my-awesome-saas-thing",
	"source.app":"thingamabobinator",
	"source.build_number":"master-666-ed3dab32"
}</code></pre>
					</section>

					<section>
						<h2>Tip: Include run-time information</h2>
						<p>Why was this decision taken</p>
							<pre><code>{
	"entity": "email",
	"status": "marked-spam",
	"reason": "source ip not authorized by SPF record"
}</code></pre>
					</section>
				</section>

				<section>
					<h2>Tip: Send IDs upstream</h2>
					Does you load-balancer/proxy set request-ids? Log them! <br/>You can possibly trace an action throughout the whole stack!!!
					<pre><code>Cloudfront: X-Request-Id: eeaa4f14-c720-4c9f-b2f8-b5b859e49e46
Load Balancer: X-Request-Id: eeaa4f14-c720-4c9f-b2f8-b5b859e49e46
Local Proxy: X-Request-Id: eeaa4f14-c720-4c9f-b2f8-b5b859e49e46
Unicorn: X-Request-Id: eeaa4f14-c720-4c9f-b2f8-b5b859e49e46
Database: X-Request-Id: eeaa4f14-c720-4c9f-b2f8-b5b859e49e46</code></pre>
					<pre><code>CloudFront -> ELB -> NGinx -> Unicorn -> ActiveRecord = 345ms</code></pre>
				</section>

				<section>
					<h2>Denormalise</h2>
					<p>You'll need to denormalise your data, a lot.</p>
					<p>Most <b>event</b> oriented data-stores are <b>NOT</b> relational.</p>
					<p>Storage is cheap.</p>
				</section>


				<section>
					<h2>Homework</h2>
					<p>Pipe you app logs somewhere and get useful data.</p>
					<p>As usual, I don't care how you do it</p>
				</section>

				<section>
					<h2>Your app</h2>
					<h3>Collection</h3>
					<p>rsyslog, flat-files, direct on the wire<p>
					<h3>Forwarding</h3>
					<p>logstash-forwarder, syslog, greylog, lumberjack, kinesis, s3</p>
				</section>
				<section>
					<h2>Logging backends</h2>
					<h3>Processing</h3>
					<p>logstash, fluentd, rsyslog, scripts, Splunk</p>
					<h3>Storage</h3>
					<p>elasticsearch, influxdb, opentsdb, mongodb, mysql</p>
				</section>

				<section>
					<h1>The point:</h1>
					<h2>Get useful data</h2>
				</section>

			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.min.js"></script>

		<script>
			// Full list of configuration options available here:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
				transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none

				// Parallax scrolling
				// parallaxBackgroundImage: 'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg',
				// parallaxBackgroundSize: '2100px 900px',

				// Optional libraries used to extend on reveal.js
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
					{ src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
				]
			});
		</script>
	</body>
</html>
